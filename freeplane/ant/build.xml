<project name="freeplane" default="dist" basedir="..">
	<property file="viewer-resources/version.properties"/>
	<property name="ver" value="${freeplane_version}" />
	<property name="ver" value="1.0.1" />
	<property name="src" value="src" />
	<property name="resources" value="resources" />
	<property name="viewer-resources" value="viewer-resources" />
	<property name="root" value="." />
	<property name="manifest" value="${root}/META-INF/OLD_MANIFEST.MF" />
	<property name="osgimanifest" value="${root}/META-INF/MANIFEST.MF" />
	<property name="lib" value="${root}/lib" />
	<property name="framework.jar" value="${root}/../freeplane_framework/lib/knopflerfish/framework.jar" />
	<property name="src_base_for_post" value="${root}/../" />
	<property name="build" value="${root}/build" />
	<property name="dist" value="${root}/bin/dist" />
	<property name="dist.lib" value="${dist}/lib" />
	<property name="dist.ortho" value="${dist}/resources/ortho" />
	<property name="dist.osgi.dir" value="${dist}/osgi/dir" />
	<property name="dist.osgi.jar" value="${dist}/osgi/jar" />
	<property name="freeplaneeditor.jar" value="${dist.lib}/freeplaneeditor.jar" />
	<property name="freeplaneviewer.jar" value="${dist.lib}/freeplaneviewer.jar" />
	<property name="freeplaneosgi.jar" value="${dist.lib}/freeplaneosgi.jar" />
	<property name="freeplaneplugin.jar" value="${dist.osgi.dir}/org.freeplane.core.jar" />
	<property name="debug" value="on" />
	<property name="java_source_version" value="1.5" />
	<property name="java_target_version" value="1.5" />
	<property name="build.compiler" value="modern" />
	<property name="classpath" value="${lib}/commons-lang-2.0.jar:${lib}/forms-1.0.5.jar:${lib}/SimplyHTML.jar:${lib}/jortho.jar:${framework.jar}" />

	<target name="build" depends="clean">
		<echo>Freeplane Version = ${ver}.</echo>
		<delete dir="${build}" quiet="true" />
		<mkdir dir="${build}" />
		<javac srcdir="${src}" destdir="${build}" classpath="${classpath}" debug="${debug}" source="${java_source_version}" target="${java_target_version}">
			<exclude name="org/freeplane/startup/FreeplaneStarter.java" />
			<exclude name="**/osgi/**" />
		</javac>
		<!-- Starter should work with java 1.1, too as it checks the java version.-->
		<delete failonerror="false" file="${build}/org/freeplane/startup/FreeplaneStarter.class">
		</delete>
		<javac verbose="yes" srcdir="${src}" destdir="${build}" classpath="${classpath}" debug="${debug}" source="1.3" target="1.1">
			<include name="org/freeplane/startup/FreeplaneStarter.java" />
		</javac>
	</target>

	<target name="osgi_build" depends="build">
		<javac srcdir="${src}" destdir="${build}" classpath="${classpath}" debug="${debug}" source="${java_source_version}" target="${java_target_version}">
			<include name="**/osgi/**" />
		</javac>
	</target>


	<target name="jar" depends="build">
		<mkdir dir="${dist.lib}" />
		<jar jarfile="${freeplaneviewer.jar}">
			<fileset dir="${build}">
				<exclude name="**/*.jar" />
				<exclude name="**/application/**" />
				<exclude name="**/osgi/**" />
				<exclude name="**/mindmapmode/**" />
				<exclude name="**/filemode/**" />
				<exclude name="**/ortho/**" />
				<exclude name="**/core/resources/ui/**" />
			</fileset>
			<fileset dir="${viewer-resources}" />
		</jar>
		<jar jarfile="${freeplaneeditor.jar}" manifest="${manifest}">
			<fileset dir="${build}">
				<include name="**/application/**" />
				<include name="**/mindmapmode/**" />
				<include name="**/ortho/**" />
				<include name="**/filemode/**" />
				<include name="**/core/resources/ui/**" />
				<exclude name="**/*.jar" />
			</fileset>
			<fileset dir="${resources}" />
		</jar>
	</target>

	<target name="osgi_jar" depends="jar, osgi_build">
		<jar jarfile="${freeplaneosgi.jar}">
			<fileset dir="${build}">
				<include name="**/osgi/**" />
			</fileset>
		</jar>
	</target>
	<target name="dist" depends="jar">
		<!-- third party libs -->
		<mkdir dir="${dist.lib}" />
		<copy todir="${dist.lib}">
			<fileset dir="${lib}">
				<include name="*.jar" />
			</fileset>
		</copy>
		<mkdir dir="${dist.ortho}" />
		<copy todir="${dist.ortho}">
			<fileset dir="ortho">
				<include name="*.ortho" />
			</fileset>
		</copy>
	</target>

	<target name="osgi_dist" depends="osgi_jar, dist">
		<mkdir dir="${dist.osgi.dir}" />
		<copy todir="${dist.osgi.dir}">
			<fileset dir="${dist}">
				<include name="lib/**" />
			</fileset>
		</copy>
		<mkdir dir="${dist.osgi.dir}/META-INF" />
		<copyfile dest="${dist.osgi.dir}/META-INF/MANIFEST.MF" src="${osgimanifest}"/>
	</target>

	<target name="osgi_dist_as_jar" depends="osgi_dist">
		<mkdir dir="${dist.osgi.jar}" />
		<jar jarfile="${freeplaneplugin.jar}">
			<fileset dir="${dist.osgi.dir}">
				<include name="**" />
			</fileset>
		</jar>
	</target>
	
	<target name="clean">
		<delete dir="${build}" quiet="true" />
		<delete dir="${dist}" quiet="true" />
		<delete dir="${post}" quiet="true" />
		<delete>
			<fileset defaultexcludes="no" dir="${src}" includes="**/*~" />
		</delete>
	</target>

</project>

