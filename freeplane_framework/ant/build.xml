<project name="freeplane" default="dist" basedir="..">
	<property name="workspace" location=".." />
	<property file="${workspace}/freeplane/viewer-resources/version.properties" />
	<property file="ant/ant.properties" />
	<property name="ver" value="${freeplane_version}" />
	<property name="root" value="." />
	<property name="build" value="${root}/build" />
	<property name="dist" value="${root}/dist" />

	<target name="build" depends="clean">
		<property name="root" value="." />
		<property name="freeplane.exe" value="windows-launcher/freeplane.exe" />
		<property name="license" value="license.txt" />
		<property name="readme_src" value="readme.txt" />
		<property name="build.jars" value="${build}/jars" />
        <property name="build.plugins" value="${build}/plugins" />
        <property name="build.core" value="${build}/core" />
        <property name="build.resources" value="${build}/resources" />
        <property name="build.doc" value="${build}/doc" />
		<property name="script" value="${root}/script" />

		<ant antfile="ant/build.xml" target="osgi_dist" dir="${workspace}/freeplane" inheritall="false" />
		<ant antfile="ant/build.xml" dir="${workspace}/freeplane_plugin_help" inheritall="false" />
		<ant antfile="ant/build.xml" dir="${workspace}/freeplane_plugin_svg" inheritall="false" />
		<ant antfile="ant/build.xml" dir="${workspace}/freeplane_plugin_latex" inheritall="false" />
		<ant antfile="ant/build.xml" dir="${workspace}/freeplane_plugin_script" inheritall="false" />
		<ant antfile="ant/build.xml" dir="${workspace}/freeplane_plugin_bugreport" inheritall="false" />
		<mkdir dir="${build}" />
		<copy todir="${build}">
			<fileset dir="${script}" />
			<fileset file="${framework.jar}" />
			<fileset file="${freeplane.exe}" />
		</copy>
		<chmod file="${build}/freeplane.sh" perm="ugo+rx" />
		<mkdir dir="${build.core}/org.freeplane.core" />
		<copy todir="${build.core}/org.freeplane.core">
			<fileset dir="${workspace}/freeplane/dist/org.freeplane.core" />
		</copy>

		<!-- temporarily remove help plugin 
		
		<mkdir dir="${build.plugins}/org.freeplane.plugin.help" />
		<copy todir="${build.plugins}/org.freeplane.plugin.help">
			<fileset dir="${workspace}/freeplane_plugin_help/dist/org.freeplane.plugin.help"/>
		</copy>
-->
		<mkdir dir="${build.plugins}/org.freeplane.plugin.latex" />
		<copy todir="${build.plugins}/org.freeplane.plugin.latex">
			<fileset dir="${workspace}/freeplane_plugin_latex/dist/org.freeplane.plugin.latex" />
		</copy>
		<mkdir dir="${build.plugins}/org.freeplane.plugin.svg" />
		<copy todir="${build.plugins}/org.freeplane.plugin.svg">
			<fileset dir="${workspace}/freeplane_plugin_svg/dist/org.freeplane.plugin.svg" />
		</copy>
		<mkdir dir="${build.plugins}/org.freeplane.plugin.script" />
		<copy todir="${build.plugins}/org.freeplane.plugin.script">
			<fileset dir="${workspace}/freeplane_plugin_script/dist/org.freeplane.plugin.script" />
		</copy>
		<mkdir dir="${build.plugins}/org.freeplane.plugin.bugreport" />
		<copy todir="${build.plugins}/org.freeplane.plugin.bugreport">
			<fileset dir="${workspace}/freeplane_plugin_bugreport/dist/org.freeplane.plugin.bugreport" />
		</copy>

        <mkdir dir="${build.resources}" />
        <copy todir="${build.resources}">
            <fileset dir="${workspace}/freeplane/dist/resources" />
        </copy>
        <mkdir dir="${build.doc}" />
        <copy todir="${build.doc}">
            <fileset dir="${workspace}/freeplane/dist/doc" />
        </copy>

	</target>

	<target name="mkdistdir">
		<mkdir dir="${dist}" />
	</target>

	<target name="binzip" depends="build, mkdistdir">
		<zip destfile="${dist}/freeplane_bin-${ver}.zip" compress="true">
			<zipfileset dir="${build}" prefix="freeplane-${ver}">
				<exclude name="freeplane.sh"/>
			</zipfileset>
            <zipfileset file="${build}/freeplane.sh" filemode="775" prefix="freeplane-${ver}">
            </zipfileset>
			<zipfileset dir="${root}" prefix="freeplane-${ver}">
				<include name="${license}" />
			</zipfileset>
		</zip>
	</target>

	<target name="srczip" depends="mkdistdir">
		<tar destfile="${dist}/freeplane_src-${ver}.tar.gz" compression="gzip" longfile="gnu">
			<tarfileset prefix="freeplane-${ver}" dir="${workspace}" mode="664">
				<patternset id="freeplane.sources">
					<include name="freeplane/**" />
					<include name="freeplane_plugin*/**" />
					<include name="freeplane_framework/**" />
					<include name="JOrtho_0.4_freeplane/**" />
					<exclude name=".*/**" />
					<exclude name="bin/**" />
					<exclude name="build/**" />
					<exclude name="dist/**" />
					<exclude name="*/bin/**" />
					<exclude name="*/build/**" />
					<exclude name="*/dist/**" />
					<exclude name="JOrtho_0.4_freeplane/src/dictionary_*.ortho" />
				</patternset>
			</tarfileset>
			<tarfileset prefix="freeplane-${ver}" dir="${root}" mode="664">
				<include name="${license}" />
				<include name="${readme_src}" />
			</tarfileset>
		</tar>

		<tar destfile="${dist}/freeplane_srcpure-${ver}.tar.gz" compression="gzip" longfile="gnu">
			<tarfileset prefix="freeplane-${ver}" dir="${workspace}" mode="664">
				<patternset refid="freeplane.sources" />
				<exclude name="**/*.jar" />
			</tarfileset>
			<tarfileset prefix="freeplane-${ver}" dir="${root}" mode="664">
				<include name="${license}" />
				<include name="${readme_src}" />
			</tarfileset>
		</tar>
	</target>

	<target name="installer" depends="build, mkdistdir">
		<exec osfamily="windows" dir="${workspace}/freeplane_framework/windows-installer" executable="iscc.exe" failifexecutionfails="false" failonerror="true">
			<arg line="/Q Freeplane_without_Java.iss" />
		</exec>
	</target>
	
	<target name="portableinstaller" depends="build, mkdistdir">
		<property name="workingdir" value="${root}/temp/FreeplanePortable" />
		<delete quiet="true" includeemptydirs="false">
			<fileset dir="${workingdir}/.." />
		</delete>
        <mkdir dir="${workingdir}/App/Freeplane" />
        <copy todir="${workingdir}">
            <fileset dir="${root}/windows-portable" />
            <fileset file="windows-launcher/freeplanePortable.exe" />
        </copy>
        <mkdir dir="${workingdir}/Other/Source" />
        <copy todir="${workingdir}/Other/Source">
            <fileset file="${workspace}/freeplane/resources/license.txt" />
        </copy>
        <copy tofile="${workingdir}/App/AppInfo/appicon.ico">
            <fileset file="windows-launcher/Freeplane_app.ico" />
        </copy>
		
		<copy todir="${workingdir}/App/Freeplane">
			<fileset dir="${build}">
				<exclude name="*.exe" />
				<exclude name="*.bat" />
				<exclude name="*.sh" />
			</fileset>
		</copy>
		<dirname property="workingdir.path" file="${workingdir}/file" />
		<exec osfamily="windows" executable="PortableApps.comInstaller.exe" failifexecutionfails="false" failonerror="true">
			<arg line="${workingdir.path}" />
		</exec>
		<move todir="${dist}">
			<fileset dir="${workingdir}/..">
				<include name="*.paf.exe" />
			</fileset>
		</move>

		<delete quiet="true" includeemptydirs="true">
			<fileset dir="${workingdir}/.." />
		</delete>

	</target>

	<target name="dist" depends="binzip, srczip, installer, portableinstaller">
		<copy file="${workspace}/freeplane/doc/history_en.txt" todir="${dist}" />
	</target>

	<target name="clean">
		<delete quiet="true" includeemptydirs="true">
			<fileset dir="${build}" />
			<fileset dir="${dist}" />
		</delete>
		  <ant antfile="ant/build.xml" target="clean" inheritall="false"
			  dir="${workspace}/freeplane"/>
		  <ant antfile="ant/build.xml" target="clean" inheritall="false"
			  dir="${workspace}/freeplane_plugin_help"/>
		  <ant antfile="ant/build.xml" target="clean" inheritall="false"
			  dir="${workspace}/freeplane_plugin_svg"/>
		  <ant antfile="ant/build.xml" target="clean" inheritall="false"
			  dir="${workspace}/freeplane_plugin_latex"/>
		  <ant antfile="ant/build.xml" target="clean" inheritall="false"
			  dir="${workspace}/freeplane_plugin_script"/>
		  <ant antfile="ant/build.xml" target="clean" inheritall="false"
			  dir="${workspace}/freeplane_plugin_bugreport"/>		
	</target>

</project>

