<project name="freeplane" default="dist" basedir="..">
	<property name = "workspace" value = ".."/>
	<property file="${workspace}/freeplane/viewer-resources/version.properties"/>
	<property name="ver" value="${freeplane_version}" />
	<property name = "root" value = "."/>
	<property name="bin" value="${root}/bin" />
	<property name="dist" value="${root}/dist" />
	
	<target name="bin" depends="clean">
		<property name = "root" value = "."/>
		<property name="framework.jar" value="lib/knopflerfish/framework.jar" />
		<property name="freeplane.exe" value="windows-launcher/freeplane.exe" />
		<property name="license" value="license.txt" />
		<property name="readme_src" value="readme.txt" />
		<property name="bin.jars" value="${bin}/jars" />
		<property name="bin.plugins" value="${bin}/plugins" />
		<property name="bin.resources" value="${bin}/resources" />
		<property name="script" value="${root}/script" />

		<ant antfile="ant/build.xml" target="osgi_dist" dir="${workspace}/freeplane" inheritall="false"/>
		<ant antfile="ant/build.xml" dir="${workspace}/freeplane_plugin_help" inheritall="false"/>
		<ant antfile="ant/build.xml" dir="${workspace}/freeplane_plugin_svg" inheritall="false"/>
		<ant antfile="ant/build.xml" dir="${workspace}/freeplane_plugin_latex" inheritall="false"/>
		<ant antfile="ant/build.xml" dir="${workspace}/freeplane_plugin_script" inheritall="false"/>
		<ant antfile="ant/build.xml" dir="${workspace}/freeplane_plugin_bugreport" inheritall="false"/>
		<mkdir dir="${bin}" />
		<copy todir="${bin}">
			<fileset dir="${script}"/>
			<fileset file="${framework.jar}"/>
			<fileset file="${freeplane.exe}"/>
		</copy>
		<chmod file="${bin}/freeplane.sh" perm="ugo+rx"/>
		<mkdir dir="${bin.plugins}/org.freeplane.core" />
		<copy todir="${bin.plugins}/org.freeplane.core">
			<fileset dir="${workspace}/freeplane/bin/dist/osgi/dir"/>
		</copy>
		<mkdir dir="${bin.plugins}/org.freeplane.plugin.help" />
		<copy todir="${bin.plugins}/org.freeplane.plugin.help">
			<fileset dir="${workspace}/freeplane_plugin_help/bin/dist/osgi/dir"/>
		</copy>
		<mkdir dir="${bin.plugins}/org.freeplane.plugin.latex" />
		<copy todir="${bin.plugins}/org.freeplane.plugin.latex">
			<fileset dir="${workspace}/freeplane_plugin_latex/bin/dist/osgi/dir"/>
		</copy>
		<mkdir dir="${bin.plugins}/org.freeplane.plugin.svg" />
		<copy todir="${bin.plugins}/org.freeplane.plugin.svg">
			<fileset dir="${workspace}/freeplane_plugin_svg/bin/dist/osgi/dir"/>
		</copy>
		<mkdir dir="${bin.plugins}/org.freeplane.plugin.script" />
		<copy todir="${bin.plugins}/org.freeplane.plugin.script">
			<fileset dir="${workspace}/freeplane_plugin_script/bin/dist/osgi/dir"/>
		</copy>
		<mkdir dir="${bin.plugins}/org.freeplane.plugin.bugreport" />
		<copy todir="${bin.plugins}/org.freeplane.plugin.bugreport">
			<fileset dir="${workspace}/freeplane_plugin_bugreport/bin/dist/osgi/dir"/>
		</copy>		
		
		<mkdir dir="${bin.resources}" />		
		<copy todir="${bin.resources}">
			<fileset dir="${workspace}/freeplane/bin/dist/resources"/>
		</copy>
		
	</target>

	<target name="dist" depends="bin">
		<mkdir dir="${dist}" />	
		
		<zip destfile="${dist}/freeplane_bin-${ver}.zip" compress="true">
			<zipfileset dir="${bin}" prefix="freeplane-${ver}"/>
			<zipfileset dir="${root}" prefix="freeplane-${ver}">
				<include name="${license}"/>
			</zipfileset>
		</zip>
		
		<tar destfile="${dist}/freeplane_src-${ver}.tar.gz" compression="gzip" longfile="gnu">
			<tarfileset prefix="freeplane-${ver}" 
				dir="${workspace}" mode="777" username="ant" group="ant">
				<include name="freeplane/**"/>
				<include name="freeplane_plugin*/**"/>
				<include name="freeplane_framework/**"/>
				<exclude name=".*/**"/>
				<exclude name="bin/**"/>
				<exclude name="dist/**"/>
				<exclude name="*/bin/**"/>
				<exclude name="*/build/**"/>
				<exclude name="*/dist/**"/>
			</tarfileset>
			<tarfileset prefix="freeplane-${ver}" dir="${root}" 
					mode="777" username="ant" group="ant">
				<include name="${license}"/>
				<include name="${readme_src}"/>
			</tarfileset>
		</tar>
		
		<copy file="${workspace}/freeplane/resources/history_en.txt" todir="${dist}"/>
		
		<exec osfamily="windows"
			dir="${workspace}/freeplane_framework/windows-installer"
			executable="C:\Program Files\Inno Setup 5\iscc.exe"
			failifexecutionfails="false"
			failonerror="true">
			<arg line="/Q Freeplane_without_Java.iss"/>
		</exec>
</target>
	<target name="clean">
		 <delete quiet="true" includeemptydirs="true">
		    <fileset dir="${bin}"/>
		    <fileset dir="${dist}"/>
		  </delete>
	</target>
	
</project>

